<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Energy Simulation - Interactive Stand</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/8.0.0/signalr.min.js"></script>
    <style>
        body {
            font-family: "Segoe UI", Arial, sans-serif;
            background-color: #ffffff;
            color: #1a1a1a;
            margin: 0;
            padding: 0;
            line-height: 1.6;
        }

        .container {
            max-width: 960px;
            margin: 0 auto;
            padding: 20px;
        }

        h1 {
            font-size: 2.5em;
            color: #2c3e50;
            border-bottom: 1px solid #e0e0e0;
            padding-bottom: 10px;
        }

        .log-section {
            margin: 20px 0;
            padding: 15px;
            background-color: #f8f8f8;
            border-left: 4px solid #0078d4;
            border-radius: 4px;
        }

            .log-section h2 {
                font-size: 1.5em;
                color: #0078d4;
                margin-top: 0;
            }

            .log-section div {
                margin: 5px 0;
                word-wrap: break-word;
            }

        .controls {
            margin: 20px 0;
        }

        select {
            padding: 10px;
            margin-right: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 1em;
        }

        button {
            background-color: #0078d4;
            color: white;
            border: none;
            padding: 10px 20px;
            margin: 5px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1em;
        }

            button:hover {
                background-color: #005bb5;
            }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }

            h1 {
                font-size: 2em;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Energy Simulation - Interactive Stand</h1>

        <div class="log-section">
            <h2>Simulation Logs</h2>
            <div id="simulationLogs"></div>
        </div>

        <div class="log-section">
            <h2>Distribution Logs</h2>
            <div id="distributionLogs"></div>
        </div>

        <div class="log-section">
            <h2>Connection Status</h2>
            <div id="connectionStatus"></div>
        </div>

        <div class="controls">
            <select id="speedFactor">
                <option value="1">1x (5 sec/step)</option>
                <option value="6">6x (30 sec/step)</option>
                <option value="60">60x (300 sec/step)</option>
                <option value="360">360x (1800 sec/step)</option>
                <option value="600">600x (3000 sec/step)</option>
                <option value="720">720x (3600 sec/step)</option>
            </select>
            <button id="startSimulation">Начать симуляцию</button>
            <button id="stopBtn">Остановить</button>
            <button id="resetBtn">Ресет</button>
        </div>
    </div>

    <script>
        const connection = new signalR.HubConnectionBuilder()
            .withUrl("/energyHub")
            .build();

        connection.on("ReceiveSimulationUpdate", (message) => {
            const div = document.createElement("div");
            div.innerText = new Date().toLocaleTimeString() + ": " + message;
            document.getElementById("simulationLogs").appendChild(div);
        });

        connection.on("ReceiveDistributionUpdate", (message) => {
            const div = document.createElement("div");
            div.innerText = new Date().toLocaleTimeString() + ": " + message;
            document.getElementById("distributionLogs").appendChild(div);
        });

        connection.on("ReceiveConnectionUpdate", (connections) => {
            const div = document.createElement("div");
            div.innerText = "Connections: " + JSON.stringify(connections, null, 2);
            document.getElementById("connectionStatus").innerHTML = "";
            document.getElementById("connectionStatus").appendChild(div);
        });

        async function startSimulation(speedFactor) {
            try {
                if (connection.state !== signalR.HubConnectionState.Connected) {
                    await connection.start();
                    console.log("Connected to SignalR Hub");
                }

                await fetch(`/api/energy/simulate/${speedFactor}`, {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json"
                    }
                });
            } catch (err) {
                console.error("Error:", err);
            }
        }

        async function stopSimulation() {
            await fetch("/api/energy/stop", { method: "POST" });
        }

        async function resetData() {
            try {
                const response = await fetch("/api/region/reset", { method: "POST" });
                const data = await response.text();
                const div = document.createElement("div");
                div.innerText = new Date().toLocaleTimeString() + ": " + data;
                document.getElementById("simulationLogs").appendChild(div);
            } catch (err) {
                console.error("Error:", err);
            }
        }

        // Привязка событий к кнопкам
        document.getElementById("startSimulation").addEventListener("click", () => {
            const speedFactor = document.getElementById("speedFactor").value;
            startSimulation(speedFactor);
        });

        document.getElementById("stopBtn").addEventListener("click", stopSimulation);
        document.getElementById("resetBtn").addEventListener("click", resetData);

        // Эмуляция нажатия кнопки по эндпоинту через SignalR
        connection.on("triggerSimulation", (data) => {
            const { speedFactor } = data;
            if (speedFactor && !isNaN(speedFactor)) {
                document.getElementById("speedFactor").value = speedFactor;
                document.getElementById("startSimulation").click(); // Эмуляция нажатия кнопки
                console.log(`Triggered simulation with speedFactor ${speedFactor} via SignalR`);
            }
        });

        // Автозапуск при загрузке (опционально)
        connection.start().catch(err => console.error(err));
    </script>
</body>
</html>